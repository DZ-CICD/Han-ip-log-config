# k8s_infra_all.yaml (최종 문법 수정 및 인증 완전 비활성화)

# 1. 네임스페이스
apiVersion: v1
kind: Namespace
metadata:
  name: db-ns
---
apiVersion: v1
kind: Namespace
metadata:
  name: frontend-ns
---
apiVersion: v1
kind: Namespace
metadata:
  name: backend-ns
---
# 2. Secret - JWT
apiVersion: v1
kind: Secret
metadata:
  name: jwt-secret
  namespace: backend-ns
type: Opaque
data:
  JWT_SECRET_KEY: azhzcGFzcyM=
---
# 3. Secret - MongoDB Backend User (mongo-pass) 제거됨
# (MongoDB 인증을 사용하지 않으므로 제거)

# 4. ConfigMaps (Frontend)
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: frontend-ns
data:
  GUESTBOOK_API_ADDR: "http://backend-external-svc.frontend-ns.svc.cluster.local:8000"
---
# 5. ConfigMaps (Backend) - MongoDB 주소 수정
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: backend-ns
data:
  # MongoDB 복제본이 1개이므로 주소를 하나만 지정하도록 수정 (인증 없음)
  GUESTBOOK_DB_ADDR: "mongodb://mongodb-0.mongo-svc.db-ns.svc.cluster.local:27017/guestbook?replicaSet=rs0"
---
# 6. Services (DB)
apiVersion: v1
kind: Service
metadata:
  name: mongo-svc
  namespace: db-ns
spec:
  ports:
    - port: 27017
      targetPort: 27017
  clusterIP: None
  selector:
    app: db
---
# 7. Services (Frontend, Backend, External)
apiVersion: v1
kind: Service
metadata:
  name: frontend-svc
  namespace: frontend-ns
spec:
  selector:
    app: frontend
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: backend-svc
  namespace: backend-ns
spec:
  selector:
    app: backend
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: backend-external-svc
  namespace: frontend-ns
spec:
  type: ExternalName
  externalName: backend-svc.backend-ns.svc.cluster.local
---
# 8. MongoDB StatefulSet (hostPath 및 인증 비활성화)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: db-ns
spec:
  serviceName: "mongo-svc"
  replicas: 1 # hostPath 사용을 위해 1로 설정
  selector:
    matchLabels:
      app: db
  template:
    metadata:
      labels:
        app: db
    spec:
      containers:
        - name: db
          image: mongo:8
          ports:
            - containerPort: 27017
          command:
            - "mongod"
            - "--replSet"
            - "rs0"
            - "--bind_ip_all"
          volumeMounts:
            - name: mongo-data
              mountPath: /data/db

      volumes:
        - name: mongo-data
          hostPath:
            path: /mnt/data/mongodb-data # 워커 노드 경로
            type: DirectoryOrCreate

---
# 9. Deployments (Frontend)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: frontend-ns
spec:
  replicas: 3
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      terminationGracePeriodSeconds: 5
      containers:
      - name: frontend
        image: 192.168.0.183/frontend/frontend:1.6
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        - name: GUESTBOOK_API_ADDR
          valueFrom:
            configMapKeyRef:
              name: frontend-config
              key: GUESTBOOK_API_ADDR
---
# 10. Deployments (Backend) - DB 인증 정보 제거
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: backend-ns
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      annotations:
        config.linkerd.io/proxy-cpu-limit: "100m"
        config.linkerd.io/proxy-cpu-request: "50m"
        config.linkerd.io/proxy-memory-limit: "128Mi"
        config.linkerd.io/proxy-memory-request: "64Mi"
      labels:
        app: backend
    spec:
      initContainers:
      - name: wait-for-db
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z -w 2 mongodb-0.mongo-svc.db-ns 27017; do echo "Waiting for MongoDB..."; sleep 2; done;']
        resources:
          limits:
            cpu: "50m"
            memory: "32Mi"
          requests:
            cpu: "25m"
            memory: "16Mi"
      containers:
      - name: backend
        image: 192.168.0.183/backend/backend:1.2
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        - name: GUESTBOOK_DB_ADDR
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: GUESTBOOK_DB_ADDR
        - name: JWT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: JWT_SECRET_KEY
        resources:
          requests:
            cpu: 100m
            memory: "100Mi"
          limits:
            cpu: 200m
            memory: "200Mi"
---
# 11. Ingress - Host 규칙 제거 및 문법 수정
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-ingress
  namespace: frontend-ns
spec:
  ingressClassName: traefik
  rules:
    - http: # ◀◀ 문법 수정 완료 (Host 필드를 제거하고 http 블록을 리스트 항목으로 정의)
        paths:
        - path: /api
          pathType: Prefix
          backend:
            service:
              name: backend-external-svc
              port:
                number: 8000
        - path: /register
          pathType: Exact
          backend:
            service:
              name: backend-external-svc
              port:
                number: 8000
        - path: /login
          pathType: Exact
          backend:
            service:
              name: backend-external-svc
              port:
                number: 8000
        - path: /reviews
          pathType: Exact
          backend:
            service:
              name: backend-external-svc
              port:
                number: 8000
        - path: /
          pathType: Prefix
          backend:
            service:
              name: frontend-svc
              port:
                number: 8000
---
# 12. HorizontalPodAutoscaler (HPA)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: backend-ns
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
